<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />
    <title>Exifãƒ‡ãƒ¼ã‚¿ã‹ã‚‰Googleãƒãƒƒãƒ—ã«è¡¨ç¤º</title>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBfTe9gdBp8vyQSArbe--BwzKWPDgWl0yA&callback=initMap"
      async
      defer
    ></script>
    <style>
      #map {
        height: 400px;
        width: 100%;
      }
      #locationTable {
        margin-top: 20px;
        font-size: 8px;
        overflow: scroll;
        width: calc(100vw - 1rem);
        height: 25vh;
      }
      #locationTable table {
        border: 1px solid black;
        border-collapse: collapse;
        width: 100%;
      }
      #locationTable th,
      #locationTable td {
        border: 1px solid black;
        padding: 5px;
      }
      .sticky_table thead th {
        background-color: silver;
        /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã«å›ºå®šã™ã‚‹ */
        position: -webkit-sticky;
        position: sticky;
        top: 0;
        /* tbodyå†…ã®ã‚»ãƒ«ã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤ºã™ã‚‹ */
        z-index: 1;
      }
      .sticky_table th:first-child {
        /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã«å›ºå®šã™ã‚‹ */
        position: -webkit-sticky;
        position: sticky;
        left: 0;
      }
      .sticky_table thead th:first-child {
        /* ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œå†…ã®ä»–ã®ã‚»ãƒ«ã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤ºã™ã‚‹ */
        z-index: 2;
      }
      #saveLocationBtn {
        width: 80vw;
        height: 20vw;
      }

      #clearLocationBtn,
      #updateMapBtn {
        width: 10rem;
        height: 2rem;
      }
    </style>
  </head>

  <body>
    <button id="saveLocationBtn">ç¾åœ¨ä½ç½®ã‚’ä¿å­˜</button>
    <input type="color" id="markerColor" value="#ff0000" />

    <details>
      <summary>ä»–ã®æ©Ÿèƒ½</summary>

      <p>å†™çœŸã‹ã‚‰ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¦åœ°å›³ã«è¡¨ç¤ºã—ã¾ã™ã€‚(è¤‡æ•°é¸æŠå¯)</p>
      <input type="file" id="photos" accept="image/*" multiple />

      <hr />

      <button id="clearLocationBtn">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>

      <button id="updateMapBtn">åœ°å›³æƒ…å ±æ›´æ–°</button>

      <hr />
      <div class="dropdown-container">
        <label for="period">ğŸ“… æœŸé–“:</label>
        <select id="period">
          <option value="2025å¹´2æœˆã€œ7æœˆ" selected="">2025å¹´2æœˆã€œ7æœˆ</option>
          <option value="2025å¹´8æœˆã€œ12æœˆ">2025å¹´8æœˆã€œ12æœˆ</option>
          <option value="2026å¹´1æœˆã€œ7æœˆ">2026å¹´1æœˆã€œ7æœˆ</option>
        </select>
      </div>
      <div class="dropdown-container">
        <label for="category">ğŸ“Œ ç¨®é¡:</label>
        <select id="category">
          <option value="è¡—å®£ãƒãƒ©ã‚·é…ã‚Š" selected="">1. è¡—å®£ãƒãƒ©ã‚·é…ã‚Š</option>
          <option value="ãƒãƒ©ã‚·ã®ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°">2. ãƒãƒ©ã‚·ã®ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°</option>
          <option value="ãƒã‚¹ã‚¿ãƒ¼è²¼ã‚Š">3. ãƒã‚¹ã‚¿ãƒ¼è²¼ã‚Š</option>
          <option value="é¸æŒ™ãƒã‚¹ã‚¿ãƒ¼æ²ç¤ºæ¿è²¼ã‚Š">
            4. é¸æŒ™ãƒã‚¹ã‚¿ãƒ¼æ²ç¤ºæ¿è²¼ã‚Š
          </option>
        </select>
      </div>
      <div>
        <label for="user_id">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</label>
        <input type="text" id="user_id" value="heureka" />
      </div>

      <button id="registerLocation">ğŸ“Œ åœ°å›³ã«ç™»éŒ²</button>
    </details>
    <div id="locationTable"></div>
    <div id="map"></div>

    <script>


      document
        .getElementById("saveLocationBtn")
        .addEventListener("click", saveCurrentLocation);
      document
        .getElementById("clearLocationBtn")
        .addEventListener("click", clearLocationData);
      document
        .getElementById("updateMapBtn")
        .addEventListener("click", updateMap);
      document
        .getElementById("registerLocation")
        .addEventListener("click", registerLocation);

      let map;
      let markers = {};
      let spreadsheetUrl = "";

      function uuid() {
        return URL.createObjectURL(new Blob()).slice(-36);
      }

      function getMarkerColor() {
        return document.getElementById("markerColor").value;
      }

      function initMap() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function (position) {
            map = new google.maps.Map(document.getElementById("map"), {
              center: {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              },
              zoom: 20,
            });
          });
        } else {
          alert("Geolocation is not supported by this browser.");
          map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 35.6895, lng: 139.6917 }, // æ±äº¬ã‚’åˆæœŸä½ç½®ã«è¨­å®š
            zoom: 8,
          });
        }

        //// åœ°å›³ãŒã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ï¼ˆå…¨ã¦ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ãŸçŠ¶æ…‹ï¼‰ã«é”ã—ãŸæ™‚ã«å®Ÿè¡Œã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        //google.maps.event.addListenerOnce(map, "idle", function () {
        //  console.log("The map is now fully loaded and idle.");
        //  // ã“ã“ã§åœ°å›³ãŒåˆ©ç”¨å¯èƒ½ã«ãªã£ãŸå¾Œã®å‡¦ç†ã‚’è¡Œã†
        //});

        //// ã¾ãŸã¯ã€tilesloadedã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ã£ã¦ã‚¿ã‚¤ãƒ«ãŒå…¨ã¦ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã™ã‚‹
        //google.maps.event.addListenerOnce(map, "tilesloaded", function () {
        //  console.log("All map tiles have been loaded.");
        //  // ã“ã“ã§åœ°å›³ãŒåˆ©ç”¨å¯èƒ½ã«ãªã£ãŸå¾Œã®å‡¦ç†ã‚’è¡Œã†
        //});

        // ä¸€å®šæ™‚é–“å¾Œã«åœ°å›³ãŒåˆ©ç”¨å¯èƒ½ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
        setTimeout(function () {
          if (map.getBounds()) {
            // getBoundsãŒå­˜åœ¨ã™ã‚‹å ´åˆã€åœ°å›³ã¯åˆ©ç”¨å¯èƒ½ã¨ã¿ãªã›ã‚‹
            console.log("Map is now usable.");
            updateMap();
          } else {
            console.error("Map is not yet ready or there was an error.");
          }
        }, 2000); // ä¾‹ãˆã°2ç§’å¾Œã«ãƒã‚§ãƒƒã‚¯
      }

      document
        .getElementById("photos")
        .addEventListener("change", function (event) {
          var files = event.target.files;
          var storedData = localStorage.getItem("locationData");
          var locationData = storedData ? JSON.parse(storedData) : {};

          for (var i = 0; i < files.length; i++) {
            (function (file) {
              var reader = new FileReader();

              reader.onload = function (e) {
                var image = new Image();
                image.onload = function () {
                  EXIF.getData(image, function () {
                    var exifData = EXIF.getAllTags(this);
                    var lat = exifData.GPSLatitude; //  EXIF.getTag(this, "GPSLatitude");
                    var lon = exifData.GPSLongitude; // EXIF.getTag(this, "GPSLongitude");
                    var dateTime = exifData.GPSDateStamp ?? "ä¸æ˜";

                    if (lat && lon) {
                      var latitude = lat[0] + lat[1] / 60 + lat[2] / 3600;
                      var longitude = lon[0] + lon[1] / 60 + lon[2] / 3600;

                      locationData[uuid()] = {
                        visible: true,
                        color: getMarkerColor(),
                        latitude: latitude,
                        longitude: longitude,
                        timestamp: dateTime,
                      };
                    }

                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                    localStorage.setItem(
                      "locationData",
                      JSON.stringify(locationData)
                    );
                    displayLocationTable(locationData);
                    updateMap();
                  });
                };
                image.src = e.target.result;
              };

              reader.readAsDataURL(file);
            })(files[i]);
          }
        });

      function saveCurrentLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function (position) {
            var newLocation = {
              visible: true,
              color: getMarkerColor(),
              latitude: position.coords.latitude,
              longitude: position.coords.longitude,
              timestamp: new Date().toISOString(),
            };

            var storedData = localStorage.getItem("locationData");
            var locationData = storedData ? JSON.parse(storedData) : {};
            locationData[uuid()] = newLocation;
            localStorage.setItem("locationData", JSON.stringify(locationData));
            displayLocationTable(locationData);
            updateMap();

            map.setCenter({
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            });
          });
        } else {
          alert("Geolocation is not supported by this browser.");
        }
      }

      function clearLocationData() {
        localStorage.removeItem("locationData");
        document.getElementById("locationTable").innerHTML = "";
        for (var key in markers) {
          markers[key].setMap(null);
        }
        alert("ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚");
      }

      function deleteLocationData(key) {
        var storedData = localStorage.getItem("locationData");
        var locationData = storedData ? JSON.parse(storedData) : {};
        delete locationData[key];
        if (markers[key]) {
          markers[key].setMap(null);
          delete markers[key];
        }
        localStorage.setItem("locationData", JSON.stringify(locationData));
        // ã‚«ãƒ¬ãƒ³ãƒˆè¡Œã‚’å‰Šé™¤
        var row = document.querySelector(`tr[data-key="${key}"]`);
        if (row) {
          row.parentNode.removeChild(row);
        }
      }

      function displayLocationTable(locationData) {
        var table =
          "<table class='sticky_table'>" +
          "<thead><tr>" +
          "<th style='width:1.3rem'>è¡¨ç¤º</th>" +
          "<th>ç·¯åº¦</th>" +
          "<th>çµŒåº¦</th>" +
          "<th>æ—¥æ™‚</th>" +
          "<th style='width:2rem'></th>" +
          "</tr><thead><tbody>";
        // locationData ã‚’é€†é †ã«ã‚½ãƒ¼ãƒˆ
        var sortedKeys = Object.keys(locationData).sort((a, b) => {
          return (
            new Date(locationData[b].timestamp) -
            new Date(locationData[a].timestamp)
          );
        });

        sortedKeys.forEach(function (key) {
          if (locationData.hasOwnProperty(key)) {
            let location = locationData[key];
            table += `<tr data-key="${key}">`;
            let checked = location.visible ? "checked" : "";
            table += `<td><input type="checkbox" class="locationCheckbox" value="${key}" ${checked}></td>`;
            table += `<td>${location.latitude}</td>`;
            table += `<td>${location.longitude}</td>`;
            table += `<td>${location.timestamp}</td>`;
            table += `<td><input type="button" value="å‰Šé™¤"  onclick="deleteLocationData('${key}')"></td>`;
            table += "</tr>";
          }
        });

        table += "</tbody></table>";
        document.getElementById("locationTable").innerHTML = table;

        var checkboxes = document.querySelectorAll(".locationCheckbox");
        checkboxes.forEach(function (checkbox) {
          checkbox.addEventListener("change", toggleLocationVisibility);
        });
      }

      function toggleLocationVisibility(event) {
        var index = event.target.value;
        var storedData = localStorage.getItem("locationData");
        var locationData = storedData ? JSON.parse(storedData) : {};
        locationData[index].visible = event.target.checked;
        localStorage.setItem("locationData", JSON.stringify(locationData));
        updateMap();
      }

      function updateMap() {
        var storedData = localStorage.getItem("locationData");
        if (storedData) {
          var locationData = JSON.parse(storedData);
          Object.entries(locationData).forEach(function ([key, location]) {
            let marker = undefined;
            if (markers[key]) {
              marker = markers[key];
            } else {
              marker = addMarker(
                location.latitude,
                location.longitude,
                key,
                location.color
              );
              markers[key] = marker;
            }

            marker.setVisible(location.visible);
          });
        }
      }

      function getMarker(color) {
        return (
          "data:image/svg+xml," +
          encodeURIComponent(
            '<svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">' +
              '<path d="M16 0c-5.523 0-10 4.477-10 10 0 10 10 22 10 22s10-12 10-22c0-5.523-4.477-10-10-10zm0 16c-3.314 0-6-2.686-6-6s2.686-6 6-6 6 2.686 6 6-2.686 6-6 6z" fill="' +
              color +
              '"/>' +
              "</svg>"
          )
        );
      }

      // Google Mapã«ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
      function addMarker(latitude, longitude, key, color) {
        let marker = new google.maps.Marker({
          key: key, // Markerã®keyã‚’ä¿æŒ(APIã«ã¯keyãŒãªã„ã®ã§ã€è‡ªå‰ã§ä¿æŒ)
          position: { lat: latitude, lng: longitude },
          map: map,
          draggable: true,
          title: "ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦å¾®èª¿æ•´",
          icon: {
            url: getMarker(color),
            scaledSize: new google.maps.Size(32, 32),
          },
        });

        // ãƒ‰ãƒ©ãƒƒã‚°ãŒå®Œäº†ã—ãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
        google.maps.event.addListener(marker, "dragend", function (event) {
          console.log(
            "ãƒãƒ¼ã‚«ãƒ¼ã®æ–°ã—ã„ä½ç½®:",
            event.latLng.lat(),
            event.latLng.lng(),
            this.key
          );

          let storedData = localStorage.getItem("locationData");
          if (storedData) {
            let locationData = JSON.parse(storedData);
            locationData[this.key].latitude = event.latLng.lat();
            locationData[this.key].longitude = event.latLng.lng();
            localStorage.setItem("locationData", JSON.stringify(locationData));
            displayLocationTable(locationData);
          }
        });
        return marker;
      }

      function registerLocation() {
        let period = document.getElementById("period").value;
        let category = document.getElementById("category").value;
        let user_id = document.getElementById("user_id").value;
        let button = document.getElementById("registerLocation");

        button.disabled = true;

        fetch(spreadsheetUrl,{
          method: "POST",
          mode: "no-cors",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            period: period,
            category: category,
            user_id: user_id,
            locationData: JSON.parse(localStorage.getItem("locationData")),
          }),
        }).then(() => {
          alert("ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚");
        }).error(() => {
          alert("ãƒ‡ãƒ¼ã‚¿ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }).finally(() => {
          button.disabled = false;
        });
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
      window.onload = function () {
        var storedData = localStorage.getItem("locationData");
        if (storedData) {
          var locationData = JSON.parse(storedData);
          displayLocationTable(locationData);
        }
        initMap();
      };
    </script>
  </body>
</html>
